---

resources:

- name: source-code
  type: git
  source:
    uri: git@github.com:pavlepredic/concourse-demo.git
    branch: master
    private_key: {{github_private_key}}

- name: release
  type: github-release
  source:
    owner: pavlepredic
    repository: concourse-demo
    access_token: {{github_access_token}}

jobs:

- name: linter
  serial: true
  plan:

  - get: source-code
    trigger: true

  - task: run-php-linter
    file: source-code/ci/tasks/run-php-linter.yml

- name: tests
  serial: true
  plan:

  - get: source-code
    trigger: true

  - task: build
    file: source-code/ci/tasks/build.yml

  - task: run-tests
    file: build-artifact/ci/tasks/run-tests.yml

- name: create-release
  serial: true
  plan:

  - get: source-code
    trigger: true
    passed: [linter,tests]

  - task: build
    file: source-code/ci/tasks/build.yml

  - task: create-tar
    file: build-artifact/ci/tasks/create-tar.yml 

  - put: release
    params:
      name: build-artifact/version
      tag: build-artifact/version
      globs:
      - releases/*.tar.gz